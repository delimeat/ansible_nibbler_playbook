- name: copy service template
  template: 
   src: pihole-docker.service.j2 
   dest: "/etc/systemd/system/pihole-docker.service"
   mode: 0755
  notify:
   - restart pihole

- name: create pihole container
  docker_container:
   name: "{{ pihole_container_name }}"
   image: "{{ pihole_image }}:{{ pihole_image_tag }}"
   pull: false
   restart_policy: no
   state: present
   hostname: "{{ pihole_hostname }}"
   networks:
    - name: "{{ proxy_net_name }}"
      ipv4_address: "{{ proxy_net_pihole_ip }}"
   ports:
    - "{{ pihole_dns_port }}:53/tcp"
    - "{{ pihole_dns_port }}:53/udp"
   env:
    ServerIP: "{{ ansible_default_ipv4.address }}"
    WEBPASSWORD: "{{ pihole_password }}"
   volumes:
    - "{{ pihole_config_dir }}:/etc/pihole"
    - "{{ pihole_dnsmasq_dir }}:/etc/dnsmasq.d"
  notify:
   - restart pihole

- name: start pihole
  systemd:
   name: pihole-docker
   state: started
   enabled: yes
   daemon_reload: yes