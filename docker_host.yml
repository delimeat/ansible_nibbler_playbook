- hosts: all
  become: yes
  gather_facts: no
  pre_tasks:
   - name: bootstrap python for ansible
     raw: test -e /usr/bin/python || (apt -y update && apt install -y python-minimal)
     changed_when: False
   - setup:
  vars:
   - hostname: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          36616134343139333763353265316436393132626332623764363061333763636636633364353836
          6131373633313839393730643036386335653564326432300a373466613266353966316131323239
          33653066663639303966643336313966663337633065633563663462376139326666643837643939
          3738666261666639610a383961383564336466323965336136356237393864666636373736356164
          6464
   - nfs_host: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          34396434356435333933366562326664636130383566343462623762353961366533626264333237
          3664663133643361386166616631316562646535663363660a353732346631343038303437356536
          33383130306234316563386332666564356133303266303731646339373434333138366333636139
          3431616434386562320a633961386163383136653531363835353438643733323130323765623262
          6263
   - nfs_path: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          31633461306334333932626461643037363933613839656132633364363338643338376635313734
          3761366534636463666166613531303135653631336233380a623038666166653831366232333736
          66303435373063666335383563653866353336643566393462386637386139333731643365623461
          3161393735613732300a366335383237313533303265383264363438656664646136353836653539
          66306136363535646162306630663834306539343836323434346261616439353036
   - linuxserver_tz: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          63316365353734363465303561636230663632376361303434393139616234303231623131383066
          6631313161373831633138326337363137653764313438370a306538393432653532646462323630
          30356664616636623333343531353733363163383231363762316664333530616239396537353961
          3165613433306630650a343137303339626231316439316566643162343761343032306630366233
          39353632383233616432396666666338353361363663313330396335613565636336
   - ddclient_subdomains: 
      - guac
      - pihole
      - plex
      - portainer
      - torrent
      - sonarr
      - radarr
      - jackett
      - cloud
   - proxy_net_nginx_ip: 172.18.0.2
   - proxy_net_guacamole_ip: 172.18.0.3
   - proxy_net_pihole_ip: 172.18.0.4
   - proxy_net_plex_ip: 172.18.0.5
   - proxy_net_portainer_ip: 172.18.0.6
   - proxy_net_vpn_client_ip: 172.18.0.7
   - proxy_net_nextcloud_ip: 172.18.0.8 
   - nginx_http_port: 80
   - nginx_https_port: 443
   - nginx_proxy:
     - { subdomain: guac, host: "{{ proxy_net_guacamole_ip }}", port: 8080, extras: ["proxy_buffering off", "access_log off"], locations: [ { path: "/", endpoint: "/guacamole/" } ] }
     - { subdomain: pihole, host: "{{ proxy_net_pihole_ip }}", port: 80, extras: [], locations: [{ path: "/", endpoint: "/admin/" } ] }
     - { subdomain: plex, host: "{{ proxy_net_plex_ip }}", port: "{{ plex_http_port }}", extras: ["proxy_cookie_path /web/ /plex/web/", "proxy_buffering off", "proxy_redirect off", "access_log off", "client_max_body_size 100M"], locations: [ { path: "/", endpoint: "/" } ] }
     - { subdomain: portainer, host: "{{ proxy_net_portainer_ip }}", port: 9000, extras: [], locations: [ {path: "/", endpoint: "/"}, { path: "/api/websocket/", endpoint: "/api/websocket/"} ] }
     - { subdomain: torrent, host: "{{ proxy_net_vpn_client_ip }}", port: 9091, extras: [], locations: [ { path: "/rpc", endpoint: "/transmission/rpc" }, {path: "/upload", endpoint: "/transmission/upload"}, { path: "/", endpoint: "/transmission/web/" } ] }
     - { subdomain: sonarr, host: "{{ proxy_net_vpn_client_ip }}", port: 8989, extras: ["proxy_redirect off", "proxy_buffering off"], locations: [ { path: "/", endpoint: "/"} ] }
     - { subdomain: radarr, host: "{{ proxy_net_vpn_client_ip }}", port: 7878, extras: ["proxy_redirect off", "proxy_buffering off"], locations: [ { path: "/", endpoint: "/"} ] }
     - { subdomain: jackett, host: "{{ proxy_net_vpn_client_ip }}", port: 9117, extras: ["proxy_redirect off", "proxy_buffering off"], locations: [ { path: "/", endpoint: "/"} ] }
     - { subdomain: cloud, host: "{{ proxy_net_nextcloud_ip }}", port: 80, extras: ["proxy_buffering off", "proxy_redirect off", "access_log off", "client_max_body_size 500M"], locations: [ { path: "/", endpoint: "/"} ] }
   - ssh_port: 22
   - plex_http_port: 32400
   - pihole_dns_port: 53
   - ufw_rules:
      - { rule: allow, port: "{{ ssh_port }}", proto: tcp }
      - { rule: allow, port: "{{ nginx_http_port }}", proto: tcp }
      - { rule: allow, port: "{{ nginx_https_port }}", proto: tcp }
      - { rule: allow, port: "{{ pihole_dns_port }}", proto: tcp }
      - { rule: allow, port: "{{ pihole_dns_port }}", proto: udp }
      - { rule: allow, port: "{{ plex_http_port }}", proto: tcp }
      - { rule: allow, port: 3005, proto: tcp }
      - { rule: allow, port: 8324, proto: tcp }
      - { rule: allow, port: 32469, proto: tcp }
      - { rule: allow, port: 1900, proto: udp }
      - { rule: allow, port: 32410, proto: udp }
      - { rule: allow, port: 32412, proto: udp }
      - { rule: allow, port: 32413, proto: udp }
      - { rule: allow, port: 32414, proto: udp }
  roles:
   - common
   - ufw
   - nfs
   - ddclient
   - docker_certbot
   - docker_nginx
   - docker_pihole
   - docker_portainer
   - docker_guacamole
   - docker_plex
   - docker_vpn_client
   - docker_transmission
   - docker_sonarr
   - docker_radarr
   - docker_jackett
   - docker_nextcloud
